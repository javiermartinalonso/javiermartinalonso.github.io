-- Buscar aquello proceso que han sido instalados posteriormente a una fecha

SELECT 
TENANTID, ID, PROCESSID, 
   NAME, VERSION, DESCRIPTION, 
   DEPLOYMENTDATE, DEPLOYEDBY, ACTIVATIONSTATE, 
   CONFIGURATIONSTATE, DISPLAYNAME, DISPLAYDESCRIPTION, 
   LASTUPDATEDATE, CATEGORYID, ICONPATH, 
   CONTENT_TENANTID, CONTENT_ID
FROM BPM.PROCESS_DEFINITION
-- donde la fecha de despliegue DEPLOYMENTDATE sea mayor que la fecha dada
WHERE ((select to_date('19700101', 'YYYYMMDD') + ( 1 / 24 / 60 / 60 / 1000) * DEPLOYMENTDATE from dual) > TO_DATE('150219', 'DDMMYY'));


-- MAS LEGIBLE
SELECT 
   NAME, VERSION, (select to_date('19700101', 'YYYYMMDD') + ( 1 / 24 / 60 / 60 / 1000) * DEPLOYMENTDATE from dual) AS DEPLOYMENTDATE, ACTIVATIONSTATE, 
   CONFIGURATIONSTATE, DISPLAYNAME
FROM BPM.PROCESS_DEFINITION
WHERE ((select to_date('19700101', 'YYYYMMDD') + ( 1 / 24 / 60 / 60 / 1000) * DEPLOYMENTDATE from dual) > TO_DATE('150219', 'DDMMYY'));





-- INFORMACION CRUZADA DE LOS PROCESOS CON LAS ORDENES DE TRABAJO, INCIDENCIAS...
select pi.name as process_name, pi.id as process_instance, fi.name as tak_name, PI.id, fi.statename, fi.displayname as task_displayname, 
fi.kind  ,FI.LASTUPDATEDATE,  ord.start_date, ord.provisioning_id, ord.customer_id, ord.customer_name, ord.service_name, sda.value as sales_reference, sda1.value as service_name2,  
sda2.value as service_action,
INCT.INCIDENT_ID, 
WO.SERVICE_REQUEST_ID,
ticket.status
from BPM.PROCESS_INSTANCE pi 
left join BPM.FLOWNODE_INSTANCE fi on  pi.id = fi.ROOTCONTAINERID 
-- EN ESTADO DE FALLO, LISTO, EJECUTANDOSE O ESPERANDO
--AND fi.statename IN ('failed', 'ready', 'executing', 'waiting')
-- EN ESPERA POR UN EVENTO
--left join BPM.FLOWNODE_INSTANCE fi on  pi.id = fi.ROOTCONTAINERID AND fi.statename IN ('waiting') AND fi.kind IN ('intermediateCatchEvent')
left join CRM_MEDIATOR.BPMPROCESS_CALL pc on  pi.id = pc.PROCESS_INSTANCE_ID
left join CRM_MEDIATOR.ACTION_PRC_CALL apc on pc.ID = apc.PROCESS_CALL_ID
left join CRM_MEDIATOR.PROVISION_ACTION act on act.id = apc.ACTION_ID
left join CRM_MEDIATOR.PROVISION_ORDER ord on ord.id = act.PROVISION_ORDER_ID 
left join CRM_MEDIATOR.SERVICE_DESCRIPTION sd on sd.ID = ord.SERVICE_DESC_ID
left join CRM_MEDIATOR.SERVICE_ATTRIBUTES sda on sd.id = sda.SERVICE_DESC_ID and sda.name = 'sales.reference'
left join CRM_MEDIATOR.SERVICE_ATTRIBUTES sda1 on sd.id = sda1.SERVICE_DESC_ID and sda1.name = 'service.name'
left join CRM_MEDIATOR.SERVICE_ATTRIBUTES sda2 on sd.id = sda2.SERVICE_DESC_ID and sda2.name = 'worksheet.action'
left join ITSM_MEDIATOR.INCIDENT inct on INCT.PROVISIONING_ID = ORD.PROVISIONING_ID
left join ITSM_MEDIATOR.WORK_ORDER wo on wo.PROVISIONING_ID = ORD.PROVISIONING_ID
left join TICKET@ITSM_DB ticket on (ticket.ticketid = INCT.INCIDENT_ID or  ticket.ticketid = WO.SERVICE_REQUEST_ID) AND ticket.EXTERNALSYSTEM = 'PROVISIONING' 
--where pi.name like '%POTS%'
where pi.name = 'Alta POTS' 
--and  sda2.value ='CHANGE' 
and  sda2.value ='NEW'
--AND pi.id = '44338'
order by pi.name asc, process_instance asc, FI.LASTUPDATEDATE asc, pi.STARTDATE asc, ord.customer_id;